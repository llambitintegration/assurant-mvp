#!/usr/bin/env node
/**
 * Worklenz Base Import Script for P0003C Data Migration
 *
 * Imports JSON files generated by Agents 1-5 into Worklenz base tables using raw SQL.
 * All tables are marked @@ignore in Prisma schema, requiring raw SQL execution.
 */

const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const path = require('path');

const prisma = new PrismaClient();

// File paths
const OUTPUT_DIR = path.join(__dirname, '../context/output');

const FILES = {
  usersTeamMembers: path.join(OUTPUT_DIR, '08-users-team-members.json'),
  projectMembers: path.join(OUTPUT_DIR, '09-project-members.json'),
  taskStatuses: path.join(OUTPUT_DIR, '10-task-statuses.json'),
  tasks: path.join(OUTPUT_DIR, '11-tasks.json'),
  taskAssignments: path.join(OUTPUT_DIR, '12-task-assignments.json'),
};

// Helper to load JSON
function loadJSON(filepath) {
  const content = fs.readFileSync(filepath, 'utf-8');
  return JSON.parse(content);
}

// Main import function
async function importData() {
  console.log('='.repeat(80));
  console.log('P0003C WORKLENZ BASE DATA IMPORT');
  console.log('='.repeat(80));

  try {
    // ========================================================================
    // STEP 1: Users & Team Members (using raw SQL)
    // ========================================================================
    console.log('\n[Step 1/5] Importing users and team members (raw SQL)...');
    const usersTeamMembers = loadJSON(FILES.usersTeamMembers);

    // Import users
    console.log('  - Importing users...');
    let userCount = 0;
    for (const user of usersTeamMembers.users) {
      await prisma.$executeRaw`
        INSERT INTO users (id, email, name, setup_completed, timezone_id, created_at, updated_at, last_active)
        VALUES (
          ${user.id}::uuid,
          ${user.email},
          ${user.name},
          ${user.setup_completed},
          ${user.timezone_id}::uuid,
          ${user.created_at}::timestamptz,
          ${user.updated_at}::timestamptz,
          ${user.last_active}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      userCount++;
    }
    console.log(`    ✓ Created ${userCount} users`);

    // Import team members
    console.log('  - Importing team members...');
    let teamMemberCount = 0;
    for (const tm of usersTeamMembers.team_members) {
      await prisma.$executeRaw`
        INSERT INTO team_members (id, user_id, team_id, role_id, active, created_at, updated_at)
        VALUES (
          ${tm.id}::uuid,
          ${tm.user_id}::uuid,
          ${tm.team_id}::uuid,
          ${tm.role_id}::uuid,
          ${tm.active},
          ${tm.created_at}::timestamptz,
          ${tm.updated_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      teamMemberCount++;
    }
    console.log(`    ✓ Created ${teamMemberCount} team members`);

    // ========================================================================
    // STEP 2: Project Members (using raw SQL)
    // ========================================================================
    console.log('\n[Step 2/5] Importing project members (raw SQL)...');
    const projectMembers = loadJSON(FILES.projectMembers);

    // Get Member role ID for project_members.role_id (required field)
    const memberRole = await prisma.$queryRaw`SELECT id FROM roles WHERE name = 'Member' LIMIT 1`;
    const memberRoleId = memberRole[0].id;

    let projectMemberCount = 0;
    for (const pm of projectMembers.project_members) {
      // Use Member role ID if role_id is null (required field)
      const roleId = pm.role_id || memberRoleId;

      await prisma.$executeRaw`
        INSERT INTO project_members (id, project_id, team_member_id, project_access_level_id, role_id, default_view, created_at)
        VALUES (
          ${pm.id}::uuid,
          ${pm.project_id}::uuid,
          ${pm.team_member_id}::uuid,
          ${pm.project_access_level_id}::uuid,
          ${roleId}::uuid,
          ${pm.default_view},
          ${pm.created_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      projectMemberCount++;
    }
    console.log(`    ✓ Created ${projectMemberCount} project members`);

    // ========================================================================
    // STEP 3: Task Statuses (using raw SQL)
    // ========================================================================
    console.log('\n[Step 3/5] Importing task statuses (raw SQL)...');
    const taskStatuses = loadJSON(FILES.taskStatuses);

    let statusCount = 0;
    for (const status of taskStatuses.task_statuses) {
      await prisma.$executeRaw`
        INSERT INTO task_statuses (id, name, project_id, team_id, category_id, sort_order)
        VALUES (
          ${status.id}::uuid,
          ${status.name},
          ${status.project_id}::uuid,
          ${status.team_id}::uuid,
          ${status.category_id}::uuid,
          ${status.sort_order}
        )
        ON CONFLICT (id) DO NOTHING
      `;
      statusCount++;
    }
    console.log(`    ✓ Created ${statusCount} task statuses`);

    // ========================================================================
    // STEP 4: Tasks (using raw SQL)
    // ========================================================================
    console.log('\n[Step 4/5] Importing tasks (raw SQL)...');
    const tasks = loadJSON(FILES.tasks);

    let taskCount = 0;
    for (const task of tasks.tasks) {
      await prisma.$executeRaw`
        INSERT INTO tasks (
          id, name, description, project_id, parent_task_id, status_id, priority_id,
          reporter_id, task_no, done, start_date, end_date, archived, sort_order,
          created_at, updated_at
        )
        VALUES (
          ${task.id}::uuid,
          ${task.name},
          ${task.description},
          ${task.project_id}::uuid,
          ${task.parent_task_id}::uuid,
          ${task.status_id}::uuid,
          ${task.priority_id}::uuid,
          ${task.reporter_id}::uuid,
          ${task.task_no},
          ${task.done},
          ${task.start_date}::timestamptz,
          ${task.end_date}::timestamptz,
          ${task.archived},
          ${task.sort_order},
          ${task.created_at}::timestamptz,
          ${task.updated_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      taskCount++;
    }
    console.log(`    ✓ Created ${taskCount} tasks`);

    // ========================================================================
    // STEP 5: Task Assignments (using raw SQL)
    // ========================================================================
    console.log('\n[Step 5/5] Importing task assignments (raw SQL)...');
    const taskAssignments = loadJSON(FILES.taskAssignments);

    let assignmentCount = 0;
    for (const assignment of taskAssignments.tasks_assignees) {
      await prisma.$executeRaw`
        INSERT INTO tasks_assignees (task_id, project_member_id, team_member_id, assigned_by, created_at)
        VALUES (
          ${assignment.task_id}::uuid,
          ${assignment.project_member_id}::uuid,
          ${assignment.team_member_id}::uuid,
          ${assignment.assigned_by}::uuid,
          ${assignment.created_at}::timestamptz
        )
        ON CONFLICT (task_id, project_member_id) DO NOTHING
      `;
      assignmentCount++;
    }
    console.log(`    ✓ Created ${assignmentCount} task assignments`);

    // ========================================================================
    // SUMMARY
    // ========================================================================
    console.log('\n' + '='.repeat(80));
    console.log('IMPORT COMPLETE');
    console.log('='.repeat(80));
    console.log('\nSummary:');
    console.log(`  - Users:               ${userCount}`);
    console.log(`  - Team Members:        ${teamMemberCount}`);
    console.log(`  - Project Members:     ${projectMemberCount}`);
    console.log(`  - Task Statuses:       ${statusCount}`);
    console.log(`  - Tasks:               ${taskCount}`);
    console.log(`  - Task Assignments:    ${assignmentCount}`);
    console.log('\n' + '='.repeat(80));

    // ========================================================================
    // VERIFICATION
    // ========================================================================
    console.log('\nVerifying data integrity...');

    // Verify users in database
    const dbUserCount = await prisma.$queryRaw`SELECT COUNT(*) as count FROM users WHERE email LIKE '%@assurant.com'`;
    console.log(`  - Assurant users in database: ${dbUserCount[0].count}`);

    // Verify team members
    const dbTeamMemberCount = await prisma.$queryRaw`
      SELECT COUNT(*) as count FROM team_members
      WHERE team_id = '8c7f9e5a-3d2b-5c1a-9f8e-7d6c5b4a3e2f'::uuid
    `;
    console.log(`  - Team members in database: ${dbTeamMemberCount[0].count}`);
    if (parseInt(dbTeamMemberCount[0].count) === 28) {
      console.log('    ✓ Team member count matches expectation (28)');
    }

    // Verify project members
    const dbProjectMemberCount = await prisma.$queryRaw`
      SELECT COUNT(*) as count FROM project_members
      WHERE project_id = 'a1b2c3d4-5e6f-5a7b-8c9d-0e1f2a3b4c5d'::uuid
    `;
    console.log(`  - Project members in database: ${dbProjectMemberCount[0].count}`);
    if (parseInt(dbProjectMemberCount[0].count) === 28) {
      console.log('    ✓ Project member count matches expectation (28)');
    }

    // Verify tasks
    const dbTaskCount = await prisma.$queryRaw`
      SELECT COUNT(*) as count FROM tasks
      WHERE project_id = 'a1b2c3d4-5e6f-5a7b-8c9d-0e1f2a3b4c5d'::uuid
    `;
    console.log(`  - Tasks in database: ${dbTaskCount[0].count}`);
    if (parseInt(dbTaskCount[0].count) === 10) {
      console.log('    ✓ Task count matches expectation (10)');
    }

    // Verify task assignments
    const dbAssignmentCount = await prisma.$queryRaw`
      SELECT COUNT(*) as count FROM tasks_assignees ta
      JOIN tasks t ON ta.task_id = t.id
      WHERE t.project_id = 'a1b2c3d4-5e6f-5a7b-8c9d-0e1f2a3b4c5d'::uuid
    `;
    console.log(`  - Task assignments in database: ${dbAssignmentCount[0].count}`);

    console.log('\n✓ All Worklenz base data imported successfully!');
    console.log('\nNext Steps:');
    console.log('  1. Refresh the Worklenz UI in your browser');
    console.log('  2. Navigate to the P0003C project');
    console.log('  3. Verify tasks appear in the Task List view');
    console.log('  4. Check the Members tab shows all 28 project members');
    console.log('  5. Verify task assignments are visible on each task');

  } catch (error) {
    console.error('\n✗ Import failed:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Run import
importData()
  .catch((error) => {
    console.error('Fatal error during import:', error);
    process.exit(1);
  });
