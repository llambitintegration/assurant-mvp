#!/usr/bin/env node
/**
 * Prisma Import Script for P0003C Data Migration
 *
 * Imports all JSON files generated by Agents 1-7 into the database using Prisma.
 * Follows the dependency order specified in the plan to ensure referential integrity.
 */

const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const path = require('path');

const prisma = new PrismaClient();

// File paths
const OUTPUT_DIR = path.join(__dirname, '../context/output');

const FILES = {
  foundation: path.join(OUTPUT_DIR, '01-foundation.json'),
  resources: path.join(OUTPUT_DIR, '02-resources.json'),
  departments: path.join(OUTPUT_DIR, '03-departments.json'),
  tasks: path.join(OUTPUT_DIR, '04-tasks.json'),
  assignments: path.join(OUTPUT_DIR, '05-department-assignments.json'),
  availability: path.join(OUTPUT_DIR, '06-availability.json'),
  allocations: path.join(OUTPUT_DIR, '07-allocations.json'),
};

// Helper to load JSON
function loadJSON(filepath) {
  const content = fs.readFileSync(filepath, 'utf-8');
  return JSON.parse(content);
}

// Main import function
async function importData() {
  console.log('='.repeat(80));
  console.log('P0003C DATA IMPORT TO PRISMA');
  console.log('='.repeat(80));

  try {
    // ========================================================================
    // STEP 1: Foundation (users, teams, projects) - Using raw SQL
    // ========================================================================
    console.log('\n[Step 1/4] Importing foundation data (raw SQL)...');
    const foundation = loadJSON(FILES.foundation);

    // Get a default timezone
    const defaultTimezone = await prisma.$queryRaw`SELECT id FROM timezones LIMIT 1`;
    const timezoneId = defaultTimezone[0].id;

    // Import users using raw SQL
    console.log('  - Importing users...');
    let userResult = { count: 0 };
    for (const user of foundation.users) {
      await prisma.$executeRaw`
        INSERT INTO users (id, email, name, timezone_id, setup_completed, created_at, updated_at, last_active)
        VALUES (
          ${user.id}::uuid,
          ${user.email},
          ${user.name},
          ${timezoneId}::uuid,
          false,
          ${user.created_at}::timestamptz,
          ${user.created_at}::timestamptz,
          ${user.created_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      userResult.count++;
    }
    console.log(`    ✓ Created ${userResult.count} users`);

    // Import teams using raw SQL
    console.log('  - Importing teams...');
    let teamResult = { count: 0 };
    const systemUserId = foundation._metadata.system_user_id;

    for (const team of foundation.teams) {
      await prisma.$executeRaw`
        INSERT INTO teams (id, name, user_id, created_at, updated_at)
        VALUES (
          ${team.id}::uuid,
          ${team.name},
          ${systemUserId}::uuid,
          ${team.created_at}::timestamptz,
          ${team.created_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      teamResult.count++;
    }
    console.log(`    ✓ Created ${teamResult.count} teams`);

    // Get a default project status
    const defaultStatus = await prisma.$queryRaw`
      SELECT id FROM sys_project_statuses WHERE name = 'Proposed' LIMIT 1
    `;
    const statusId = defaultStatus[0].id;

    // Import projects using raw SQL
    console.log('  - Importing projects...');
    let projectResult = { count: 0 };
    for (const project of foundation.projects) {
      // Use system user ID as owner (first user in foundation.users)
      const ownerId = foundation.users[0].id;

      await prisma.$executeRaw`
        INSERT INTO projects (
          id, name, key, team_id, owner_id, status_id,
          start_date, end_date, color_code, tasks_counter,
          created_at, updated_at
        )
        VALUES (
          ${project.id}::uuid,
          ${project.name},
          ${project.key},
          ${project.team_id}::uuid,
          ${ownerId}::uuid,
          ${statusId}::uuid,
          ${project.start_date}::timestamptz,
          ${project.end_date}::timestamptz,
          '#70a6f3',
          0,
          ${project.created_at}::timestamptz,
          ${project.created_at}::timestamptz
        )
        ON CONFLICT (id) DO NOTHING
      `;
      projectResult.count++;
    }
    console.log(`    ✓ Created ${projectResult.count} projects`);

    // ========================================================================
    // STEP 2: Core entities (resources, departments) - PARALLEL
    // Note: Skipping tasks - no tasks model in RCM schema yet
    // ========================================================================
    console.log('\n[Step 2/3] Importing core entities (parallel)...');
    const resources = loadJSON(FILES.resources);
    const departments = loadJSON(FILES.departments);

    const [resourceResult, departmentResult] = await Promise.all([
      // Import resources
      (async () => {
        console.log('  - Importing resources...');
        // Remove 'name' field from each resource as it's not in the schema
        const resourcesData = resources.rcm_resources.map(r => {
          const { name, ...rest } = r;
          return rest;
        });
        const result = await prisma.rcm_resources.createMany({
          data: resourcesData,
          skipDuplicates: true,
        });
        console.log(`    ✓ Created ${result.count} resources`);
        return result;
      })(),

      // Import departments
      (async () => {
        console.log('  - Importing departments...');
        const result = await prisma.rcm_departments.createMany({
          data: departments.rcm_departments,
          skipDuplicates: true,
        });
        console.log(`    ✓ Created ${result.count} departments`);
        return result;
      })(),
    ]);

    // ========================================================================
    // STEP 3: Relationships (assignments, availability) - PARALLEL
    // ========================================================================
    console.log('\n[Step 3/3] Importing relationships and allocations...');
    const assignments = loadJSON(FILES.assignments);
    const availability = loadJSON(FILES.availability);

    const [assignmentResult, availabilityResult] = await Promise.all([
      // Import department assignments
      (async () => {
        console.log('  - Importing department assignments...');
        // Map field names: created_by → assigned_by, created_at → assigned_at
        const assignmentsData = assignments.rcm_resource_department_assignments.map(a => {
          const { created_by, created_at, ...rest } = a;
          return {
            ...rest,
            assigned_by: created_by,
            assigned_at: created_at
          };
        });
        const result = await prisma.rcm_resource_department_assignments.createMany({
          data: assignmentsData,
          skipDuplicates: true,
        });
        console.log(`    ✓ Created ${result.count} department assignments`);
        return result;
      })(),

      // Import availability
      (async () => {
        console.log('  - Importing availability records...');
        // Handle different key names in JSON (might be rcm_availability or rcm_resource_availability)
        const availabilityRaw = availability.rcm_availability || availability.rcm_resource_availability;
        // Convert date strings to ISO DateTime format
        const availabilityData = availabilityRaw.map(a => ({
          ...a,
          effective_from: new Date(a.effective_from).toISOString(),
          effective_to: a.effective_to ? new Date(a.effective_to).toISOString() : null
        }));
        const result = await prisma.rcm_availability.createMany({
          data: availabilityData,
          skipDuplicates: true,
        });
        console.log(`    ✓ Created ${result.count} availability records`);
        return result;
      })(),
    ]);

    // ========================================================================
    // STEP 3b: Allocations (sequential - part of step 3)
    // ========================================================================
    console.log('  - Importing allocations...');
    const allocations = loadJSON(FILES.allocations);

    // Convert date strings to ISO DateTime format
    const allocationsData = allocations.rcm_allocations.map(a => ({
      ...a,
      start_date: new Date(a.start_date).toISOString(),
      end_date: new Date(a.end_date).toISOString()
    }));

    const allocationResult = await prisma.rcm_allocations.createMany({
      data: allocationsData,
      skipDuplicates: true,
    });
    console.log(`    ✓ Created ${allocationResult.count} allocations`);

    // ========================================================================
    // SUMMARY
    // ========================================================================
    console.log('\n' + '='.repeat(80));
    console.log('IMPORT COMPLETE');
    console.log('='.repeat(80));
    console.log('\nSummary:');
    console.log(`  - Users:                  ${userResult.count}`);
    console.log(`  - Teams:                  ${teamResult.count}`);
    console.log(`  - Projects:               ${projectResult.count}`);
    console.log(`  - Resources:              ${resourceResult.count}`);
    console.log(`  - Departments:            ${departmentResult.count}`);
    console.log(`  - Department Assignments: ${assignmentResult.count}`);
    console.log(`  - Availability Records:   ${availabilityResult.count}`);
    console.log(`  - Allocations:            ${allocationResult.count}`);
    console.log('\n' + '='.repeat(80));

    // ========================================================================
    // VERIFICATION
    // ========================================================================
    console.log('\nVerifying data integrity...');

    // Verify total hours match TSV (33,596 person-hours)
    const totalHours = allocations._metadata.total_hours || 0;
    console.log(`  - Total hours from allocations: ${totalHours.toLocaleString()}`);
    if (totalHours === 33596) {
      console.log('    ✓ Total person-hours match expected (33,596)');
    } else {
      console.log(`    ⚠ Warning: Total hours mismatch. Expected 33,596, got ${totalHours}`);
    }

    // Verify resource count
    const resourceCount = await prisma.rcm_resources.count();
    console.log(`  - Resources in database: ${resourceCount}`);
    if (resourceCount === 27) {
      console.log('    ✓ Resource count matches expectation (27)');
    }

    // Verify department count
    const departmentCount = await prisma.rcm_departments.count();
    console.log(`  - Departments in database: ${departmentCount}`);
    if (departmentCount === 14) {
      console.log('    ✓ Department count matches expectation (14)');
    }

    console.log('\n✓ All RCM data imported successfully!');

  } catch (error) {
    console.error('\n✗ Import failed:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Run import
importData()
  .catch((error) => {
    console.error('Fatal error during import:', error);
    process.exit(1);
  });
